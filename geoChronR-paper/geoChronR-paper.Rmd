---
title: GeoChronR: an R framework to model and analyze age-uncertain paleogeoscientific timeseries.
journal: "`r rticles::copernicus_journal_abbreviations(journal_name = 'communication')`"
author:
  - given_name: Nicholas
    surname: McKay
    affiliation: 1
    email: Nicholas.McKay@nau.edu
    corresponding: true
  - given_name: Julien
    surname: Emile-Geay
    affiliation: 2
    email: julieneg@usc.edu
  - given_name: Deborah
    surname: Khider
    affiliation: 2
# If you have more than one corresponding author, add them manually using the following structure:
# Two authors: \correspondence{Daniel N端st (daniel.nuest@uni-muenster.de) and Josiah Carberry (j.carberry@orcid.org)}
# Three authors or more: \correspondence{Daniel N端st (daniel.nuest@uni-muenster.de), Josiah Carberry j.carberry@orcid.org), and Markus Konkol (m.konkol@wwu.de)}
# If the following line is uncommented, the "corresponding: true" above are ignored
#correspongdingauthors: Daniel N端st (daniel.nuest@uni-muenster.de) and Josiah Carberry (j.carberry@orcid.org)
affiliation:
  - code: 1
    address: School of Earth and Sustainability, Northern Arizona University, Flagstaff, AZ 86011
  - code: 2
    address: University of Southern California, Los Angeles, CA
abstract: |

  Chronological uncertainty is a hallmark of the paleosciences. While many tools have been made available to researchers to produce age models suitable for various settings and assumptions, disparate tools and output formats often discourage integrative approaches. In addition, propagating age model uncertainties to subsequent analyses, and visualizing the results, has received comparatively little attention in the literature and available software. Here we describe GeoChronR, an open-source R package to facilitate these tasks. GeoChronR is built around emerging data standards for the paleosciences (Linked Paleo Data, or LiPD), and offers access to four popular age modeling techniques (Bacon, BChron, Oxcal, BAM). The output of these models is easily stored in LiPD, enabling paleo-aware synchronization, regression, correlation, principal component, and spectral analyses. Five real-world use cases illustrate how to use GeoChronR to facilitate these tasks, and to visualize the results in intuitive ways. 

bibliography: geochronr.bib
running:
  title: The GeoChronR framework
  author: McKay et al.
# This section is mandatory even if you declare that no competing interests are present.
competinginterests: |
  The authors declare no competing interests.
# OPTIONAL:
algorithms: true
# See https://publications.copernicus.org/for_authors/licence_and_copyright.html, normally used for transferring the copyright, if needed.
copyrightstatement: |
  The author's copyright for this publication is transferred to institution/company.
### The following commands are for the statements about the availability of data sets and/or software code corresponding to the manuscript.
### It is strongly recommended to make use of these sections in case data sets and/or software code have been part of your research the article is based on.
availability:
  #code: |
  #  use this to add a statement when having only software code available
  #data: |
  #  use this to add a statement when having only data sets available
  codedata: |
    use this to add a statement when having data sets and software code available
  #sample: |
  #  use this section when having geoscientific samples available
  #videosupplement: |
  #use this section when having video supplements available
  authorcontribution: |
    NPM did... JEG did a lot o cheerleading, created lots of bugs, but did manage to write one vignette. DK did...
disclaimer: |
  disc
acknowledgements: |
  ack
appendix: |
  \section{Figures and tables in appendices}
  Regarding figures and tables in appendices, the following two options are possible depending on your general handling of figures and tables in the manuscript environment:
  \subsection{Option 1}
  If you sorted all figures and tables into the sections of the text, please also sort the appendix figures and appendix tables into the respective appendix sections.
  They will be correctly named automatically.
  \subsection{Option 2}
  If you put all figures after the reference list, please insert appendix tables and figures after the normal tables and figures.

  To rename them correctly to A1, A2, etc., please add the following commands in front of them:
  `\appendixfigures` needs to be added in front of appendix figures
  `\appendixtables` needs to be added in front of appendix tables

  Please add `\clearpage` between each table and/or figure. Further guidelines on figures and tables can be found below.
output:
  rticles::copernicus_article: default
  bookdown::pdf_book:
    base_format: rticles::copernicus_article # for using bookdown features like \@ref()
---

\introduction

<!-- Introduction text goes here. -->
<!-- You can change the name of the section if neccessary using `\introduction[modified heading]`. -->

<!-- The following settings can or must be configured in the header of this file and are bespoke for Copernicus manuscripts: -->

<!-- - The `journal` you are submitting to using the official abbreviation. You can use the function `rticles::copernicus_journal_abbreviations(name = '...')` to search the existing journals. -->

<!-- - Specific sections of the manuscript: -->

<!--   - `running` with `title` and `author` -->

<!--   - `competinginterests` -->

<!--   - `copyrightstatement` (optional) -->

<!--   - `availability` (strongly recommended if any used), one of `code`, `data`, or `codedata` -->

<!--   - `authorcontribution` -->

<!--   - `disclaimer` -->

<!--   - `acknowledgements` -->

<!-- See the defaults and examples from the skeleton and the official Copernicus documentation for details. -->

<!-- **Important**: Always double-check with the official manuscript preparation guidelines at [https://publications.copernicus.org/for_authors/manuscript_preparation.html](https://publications.copernicus.org/for_authors/manuscript_preparation.html), especially the sections "Technical instructions for LaTeX" and "Manuscript composition". -->
<!-- Please contact Daniel N端st, `daniel.nuest@uni-muenster.de`, with any problems. -->

## Background

Review the need for, and examples of age uncertain analysis in the literature.


## Motivation

Why we built geoChronR


## Outline of manuscript

Should we include this section?  yes. 

<!-- Age modeling section -->


# Age Modeling with GeoChronR

## Bacon


## BChron



## Oxcal


## Banded Age Model (BAM)

<!-- Analysis section -->


# Age-uncertain data analysis in GeoChronR

Intro on analytical approach, using ensembles....

## Correlation


## Regression


## Principal Component Analysis

## Spectral Analysis

<!-- Viz section -->

# Visualization with GeoChronR

ggplot philosophy. Customization. 

### Timeseries

### Geospatial
WTF does geospatial mean anyway?
### Spectral Analysis


# Use cases

We now illustrate the use of these tools on four use cases. The first example shows how to create age ensembles on different archives, and how to visualize the timing of abrupt events with appropriate uncertainty quantification. The second example shows how to quantify similarities in age-uncertain records. The third introduces the topic of age-uncertain calibrations, the fourth quantifies multivariate relationships using principal components analyses, and the fifth deal with spectral analysis. 


## Creating an age ensemble 

A common first task when using geoChronR is to create an age ensemble, either because the user is developing a new record, or because the age ensemble data for the record they are interested is unavailable.
As described in section X.Y workflows for four published age quantification programs are integrated into geoChronR.
Bacon [@bacon], BChron [@parnell2008flexible], and OxCal [@ramsey2008deposition] are Bayesian age-deposition models that estimate posteriors on age-depth relationships with different assumptions and methodologies.
BAM [@BAM] was designed to probabilistically simulate counting uncertainty in banded archives, such as corals, ice cores, or varved sediments, but can also be used to simulate age uncertainty for any record, and is useful when the data or metadata required to calculate an age-depth model are unavailable.
All four methods are mostly simply used in geoChronR with a LiPD file that contains the chronological measurements, and the functions `runBacon(L)`, `runBchron(L)`, `runOxcal(L)` and `runBam(L)`.
These functions take LiPD objects as inputs, and return updated LiPD objects that include age-ensemble data generated by the respective software packages.
Typically, additional parameters are needed for to optimally run the algorithms.
When these parameters are not included, geoChronR will run in interactive mode, asking the user which variables and parameters they would like to model.
These parameter choices are printed to the screen during while the program runs, or are available later with the function `getLastVarString()`.
By specifying these parameters, age model creation can be scripted and will run in non-interactive mode.
In this use case, we'll use geoChronR and BChron [@parnell2008flexible] to calculate an age ensemble for the Hulu Cave $\delta^{18}$O speleothem record [@hulu2001], and BAM [@BAM] to simulate age uncertainties for the GISP2 ice core $\delta^{18}$O dataset [@alley].
The `plotChronEns(hulu)` function will plot an age-depth model and uncertainties derived from the age ensemble.

```{r, echo=FALSE,results='hide',warning = FALSE, message = FALSE}
## ---- results = FALSE, warning = FALSE, message= FALSE------------------------
library(lipdR)
library(geoChronR)
library(magrittr)
library(ggplot2)
library(dplyr)
library(purrr)
```

```{r, echo=FALSE,results='hide',warning = FALSE, message = FALSE,cache=TRUE}
hulu <- lipdR::readLipd("http://lipdverse.org/geoChronR-examples/Hulucave.Wang.2001.lpd")

hulu <- runBchron(hulu,
                  cal.curves = "normal",
                  iter = 10000,
                  extractDate = 10000,
                  which.table = 2,
                  lab.id.var = NULL,
                  age.var = 'age',
                  age.uncertainty.var = 'ageUncertaintyHigh',
                  age.14c.var = NULL,
                  age.14c.uncertainty.var =  NULL,
                  depth.var = 'depth',
                  reservoir.age.14c.var = NULL,
                  reservoir.age.14c.uncertainty.var = NULL,
                  rejected.ages.var = NULL)
```

```{r,echo=FALSE}
plotChronEns(hulu,truncate.dist = 1e-4)+ggtitle(NULL)
```
After an age ensemble has been added to a LiPD object, the user can visualize the ensemble timeseries using `plotTimeseriesEnsRibbons()` and `plotTimeseriesEnsLines()`.
GISP2 $\delta^{18}$O is plotted with age uncertainty, using both functions, in figure x.

```{r, echo=FALSE,results='hide',warning = FALSE, message = FALSE, cache= TRUE}
gisp2 <- lipdR::readLipd("http://lipdverse.org/geoChronR-examples/GISP2.Alley.2000.lpd")

gisp2 <- runBam(gisp2,
               paleo.num = 1,
               paleo.meas.table.num = 1,
               chron.num = 1,
               model.num = 1,
               ens.table.number = 1,
               make.new = T,
               n.ens = 1000,
               model = list(name = "poisson",
                            param = 0.02,
                            resize = 0,
                            ns = 1000)
               )
gisp2.d18O <- selectData(gisp2,var.name = "temp")

gisp2.ens <- selectData(gisp2,var.name = "yearEnsemble")
gisp2.ens <- convertAD2BP(gisp2.ens)
```


<<<<<<< HEAD
plotTimeseriesEnsRibbons(X = gisp2.ens,Y = gisp2.d18O,n.bins = 500) %>%
=======
```{r,echo=FALSE}
plotTimeseriesEnsRibbons(X = gisp2.ens,Y = gisp2.d18O,n.bins = 500) %>% 
>>>>>>> 03686236142ce237d35dffada589718968e18179
  plotTimeseriesEnsLines(X = gisp2.ens,Y = gisp2.d18O,n.ens.plot = 5,color = "Reds",alp = .2)+
  ggtitle(NULL)
```

## Correlation

Now that the user has generated age ensembles for the two datasets, they're interested to see if a correlation between the two datasets is robust to the age uncertainty modeled here.
On multi-millennial timescales, the two datasets have similarities, and previous work has suggested that could events during the Last Glacial period, which are observed in the GISP2 record, can impact the Asian Monsoon and be observed is speleothem records such as the Hulu Cave dataset. (NM: add references here and flesh out background)
The `corEns()` function in geoChronR will calculate ensemble correlations across age-uncertain datasets, such as these.
`corEns()` will also sample across ensembles in the paleoData as well, if present.
Here we calculate correlations during the period of overlap in 500 yr steps, determining significance for each pair of ensemble members while accounting for autocorrelation.

```{r, echo=FALSE,results='hide',warning = FALSE, message = FALSE,cache = TRUE}
hulu <- mapAgeEnsembleToPaleoData(hulu,age.var = "ageEnsemble",paleo.meas.table.num = 2)
hulu.ae <- selectData(hulu,var.name = "ageEnsemble",meas.table.num = 2)
hulu.d18O<- selectData(hulu,var.name = "d18O",meas.table.num = 2)
corout <- corEns(gisp2.ens,gisp2.d18O,hulu.ae,hulu.d18O,bin.step = 500,max.ens = 100)
corPlot <- plotCorEns(corout,legend.position = c(0.1, 0.8),significance.option = "autocorr")
```

The results show consistently negative correlations, although `r sum(corout$cor.df$r>0)/nrow(corout$cor.df)*100`% of the ensemble members are positive.
However, only `r sum(corout$cor.df$pSerial < 0.05)/nrow(corout$cor.df)*100`% are significant after accounting for serial autocorrelation.

```{r, echo = FALSE}
print(corPlot)+ggtitle(NULL)
```


In this use case, we demonstrate how a user could calculate and visualize and age-uncertain correlation between the Hulu speleothem $\delta^{18}\mathrm{O}$ record and the GISP2 ice core $\delta^{18}\mathrm{O}$ record. (Introduction about why a user might want to do an age uncertain correlation between Hulu and GISP2).


## Age-uncertain Calibration
A natural extension of ensemble correlation is ensemble regression.
Although there are use cases where regressing one age-uncertain variable onto another is called for, here we regress an age-uncertain paleoclimate proxy onto time-certain instrumental to develop a calibration-in-time.
For this use case, we reproduce the results of @Boldt:2015, where the authors calibrate a spectral reflectance measure of chlorophyll abundance to temperature in Northern Alaska.

```{r, echo=FALSE,results='hide',warning = FALSE, message = FALSE, cache = TRUE}
library(readr)
K <- lipdR::readLipd("http://lipdverse.org/geochronr-examples/Kurupa.Boldt.2015.lpd")
K <- lipdR::readLipd("~/GitHub/lipdverse/html/geoChronR-examples/Kurupa.Boldt.2015.ens.lpd")
K <- mapAgeEnsembleToPaleoData(K,age.var = "ageEnsemble")
kae <-  selectData(K,"ageEnsemble")
rabd <- selectData(K,"RABD")
kurupa.instrumental <- readr::read_csv("http://lipdverse.org/geochronr-examples/KurupaInstrumental.csv")
kae = convertBP2AD(kae)

kyear = list()
kyear$values = kurupa.instrumental[,1]
kyear$variableName = "year"
kyear$units = "AD"

kinst = list()
kinst$values = kurupa.instrumental[,2]
kinst$variableName = "Temperature"
kinst$units = "deg (C)"

regout = regressEns(time.x = kae,values.x = rabd,time.y =kyear,values.y =kinst,bin.step=3,recon.bin.vec = seq(-4010,2010,by=20),percentiles = c(5,50,95))
```

```{r,echo = FALSE}
regPlots <- plotRegressEns(regout,alp = 0.01)
```
Figure captions.

## Principle Component Analysis

Thus far, the use cases have highlighted age-uncertain analyses of one or two sites, however quantifying the effects of age uncertainty can be even more impactful over large spatial datasets. 
Here we showcase how to use geoChronR to perform age-uncertain principle components analysis (PCA), also known as Monte Carlo Empirical Orthogonal Function (MCEOF) analysis, pioneered by @anchukaitis2013mceof.
In this example, we examine the Arctic 2k database [@McKayKaufman2014McKayKaufman2014].

```{r, echo=FALSE,results='hide',warning = FALSE, message = FALSE, cache = TRUE}
FD <- readLipd("http://lipdverse.org/geoChronR-examples/arc2k/Arctic2k.zip") 
FD2 = purrr::map(FD,
                 mapAgeEnsembleToPaleoData,
                 strict.search = TRUE,
                 age.var = "ageEnsemble",
                 depth.var = NULL )
TS = extractTs(FD2)
TS.filtered = filterTs(TS,"interpretation1_variable == T")
tidyDf <- tidyTs(TS.filtered)
```

```{r,echo = FALSE}

plotTimeseriesStack(tidyDf, 
                    color.var = "paleoData_variableName", 
                    color.ramp = c("DarkBlue","Orange","Black","Dark Green"),
                    line.size = .1, 
                    fill.alpha = .05,
                    lab.size = 2,
                    lab.space = 3)
```

```{r, echo=FALSE,results='hide',warning = FALSE, message = FALSE, cache = TRUE}

binned.TS = binTs(TS.filtered,bin.vec = seq(1400,2000,by=5),time.var = "ageEnsemble")
pcout = pcaEns(binned.TS)


```



```{r,echo = FALSE}
plotPCA <- plotPcaEns(pcout,TS = TS.filtered,map.type = "line",projection = "stereo",bound.circ = T,restrict.map.range = T,f=.1,legend.position = c(0.5,.6),which.pcs = 1:2,which.leg = 2)
```

## Spectral Analysis


# Discussion & Conclusion

- Strengths, weaknesses and shortcomings of our approach

- Next steps; where does age-uncertain work go from here?

- GeoChronR plans, longevity, etc







# Everything below are useful examples of how to use RMarkdown


Subsection text here.

### Subsubsection Heading Here

Subsubsection text here.

# Content section with citations

See the [R Markdown docs for bibliographies and citations](http://rmarkdown.rstudio.com/authoring_bibliographies_and_citations.html).

Copernicus supports biblatex. I put the .bib entries from the Paleocube proposal into `geochronr.bib`. Citations work like this:

Read [@Evans_QSR13], and [see @PRYSM].

# Content section with R code chunks

```{r, echo = FALSE}
sum <- 1 + 41
```

You should always use `echo = FALSE` on R Markdown code blocks as they add formatting and styling not desired by Copernicus.
The hidden workflow results in `r sum`.

You can add verbatim code snippets without extra styles by using ` ``` ` without additional instructions.

```
sum <- 1 + 41
```

# Content section with list

If you want to insert a list, you must

- leave

- empty lines

- between each list item

because the `\tightlist` format used by R Markdown is not supported in the Copernicus template. Example:

```
- leave

- empty lines

- between each list item
```

# Examples from the official template

## FIGURES

When figures and tables are placed at the end of the MS (article in one-column style), please add \clearpage between bibliography and first table and/or figure as well as between each table and/or figure.

### ONE-COLUMN FIGURES

Include a 12cm width figure of Nikolaus Copernicus from [Wikipedia](https://en.wikipedia.org/wiki/File:Nikolaus_Kopernikus.jpg) with caption using R Markdown.

```{r, out.width = "8.3cm", echo = FALSE, fig.cap = "one column figure"}
knitr::include_graphics("Nikolaus_Kopernikus.jpg")
```

### TWO-COLUMN FIGURES

You can also include a larger figure.

```{r, out.width = "12cm", echo = FALSE, fig.cap = "two column figure"}
knitr::include_graphics("Nikolaus_Kopernikus.jpg")
```

## TABLES

You can ad \LaTeX table in an R Markdown document to meet the template requirements.

### ONE-COLUMN TABLE

\begin{table}[t]
\caption{TEXT}
\begin{tabular}{l c r}
\tophline

a & b & c \\
\middlehline
1 & 2 & 3 \\

\bottomhline
\end{tabular}
\belowtable{Table Footnotes}
\end{table}

### TWO-COLUMN TABLE

\begin{table*}[t]
\caption{TEXT}
\begin{tabular}{l c r}
\tophline

a & b & c \\
\middlehline
1 & 2 & 3 \\

\bottomhline
\end{tabular}
\belowtable{Table footnotes}
\end{table*}

## MATHEMATICAL EXPRESSIONS

All papers typeset by Copernicus Publications follow the math typesetting regulations given by the IUPAC Green Book (IUPAC: Quantities, Units and Symbols in Physical Chemistry, 2nd Edn., Blackwell Science, available at: http://old.iupac.org/publications/books/gbook/green_book_2ed.pdf, 1993).

Physical quantities/variables are typeset in italic font (t for time, T for Temperature)

Indices which are not defined are typeset in italic font (x, y, z, a, b, c)

Items/objects which are defined are typeset in roman font (Car A, Car B)

Descriptions/specifications which are defined by itself are typeset in roman font (abs, rel, ref, tot, net, ice)

Abbreviations from 2 letters are typeset in roman font (RH, LAI)

Vectors are identified in bold italic font using \vec{x}

Matrices are identified in bold roman font

Multiplication signs are typeset using the LaTeX commands `\times` (for vector products, grids, and exponential notations) or `\cdot`

The character * should not be applied as mutliplication sign

## EQUATIONS

### Single-row equation

Unnumbered equations (i.e. using `$$` and getting inline preview in RStudio) are not supported by Copernicus.

\begin{equation}
1 \times 1 \cdot 1 = 42
\end{equation}

\begin{equation}
A = \pi r^2
\end{equation}

\begin{equation}
x=\frac{2b\pm\sqrt{b^{2}-4ac}}{2c}.  
\end{equation}

### Multiline equation

\begin{align}
& 3 + 5 = 8\\
& 3 + 5 = 8\\
& 3 + 5 = 8
\end{align}

## MATRICES

$$
\begin{matrix}
x & y & z\\
x & y & z\\
x & y & z\\
\end{matrix}
$$

## ALGORITHM

If you want to use algorithms, you can either enable the required packages in the header (the default, see `algorithms: true`), or make sure yourself that the \LaTeX packages `algorithms` and `algorithmicx` are installed so that `algorithm.sty` respectively `algorithmic.sty` can be loaded by the Copernicus template.
Copernicus staff will remove all undesirable packages from your LaTeX source code, so please stick to using the header option, which only adds the two acceptable packages.

\begin{algorithm}
\caption{Algorithm Caption}
\label{a1}
\begin{algorithmic}
\STATE $i\gets 10$
\IF {$i\geq 5$}
        \STATE $i\gets i-1$
\ELSE
        \IF {$i\leq 3$}
                \STATE $i\gets i+2$
        \ENDIF
\ENDIF
\end{algorithmic}
\end{algorithm}

## CHEMICAL FORMULAS AND REACTIONS

For formulas embedded in the text, please use `\chem{}`, e.g. \chem{A \rightarrow B}.

The reaction environment creates labels including the letter R, i.e. (R1), (R2), etc.

- `\rightarrow` should be used for normal (one-way) chemical reactions

- `\rightleftharpoons` should be used for equilibria

- `\leftrightarrow` should be used for resonance structures

\begin{reaction}
A \rightarrow B \\
\end{reaction}
\begin{reaction}
Coper \rightleftharpoons nicus \\
\end{reaction}
\begin{reaction}
Publi \leftrightarrow cations
\end{reaction}

## PHYSICAL UNITS

Please use `\unit{}` (allows to save the math/`$` environment) and apply the exponential notation, for example \( 3.14\,\unit{km\,h^{-1}} \) (using LaTeX mode: `\( 3.14\,\unit{...} \)`) or \unit{0.872\,m\,s^{-1}} (using only `\unit{0.872\,m\,s^{-1}}`).

\conclusions

The conclusion goes here.
You can modify the section name with  `\conclusions[modified heading if necessary]`.
